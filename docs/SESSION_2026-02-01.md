# Workshop Athena Checkout - Session Documentation

**Date:** 2026-02-01  
**Project:** Workshop Nanobanana Core Checkout  
**Live URL:** https://workshop.agentikai.app

---

## ğŸ“‹ Summary of Changes

This session focused on implementing **Telegram notifications** for the sales funnel and configuring **Mercado Pago payment options**.

---

## ğŸ”” Telegram Notifications System

### Implementation

Created a centralized notification utility at `lib/notifications.ts`:

```typescript
export async function sendTelegramMessage(params: {
    message: string;
    source: string;
}) {
    const token = process.env.TELEGRAM_BOT_TOKEN;
    const chatId = process.env.TELEGRAM_CHAT_ID;
    // ... sends message via Telegram Bot API
}
```

### Notification Triggers

| Stage | Trigger | Message Type |
|-------|---------|--------------|
| ğŸ“ **Checkout Started** | User submits form | Name, Email, WhatsApp, Amount |
| â³ **Payment Pending** | PIX generated | Payment ID, Amount, Status |
| âœ… **Payment Approved** | Payment confirmed | Full payment details |
| âŒ **Payment Rejected** | Payment failed | Error status |

### Files Modified

1. **`app/api/mercadopago/checkout/route.ts`**
   - Added Telegram notification on form submission
   - Uses `sendTelegramMessage` utility

2. **`app/api/mercadopago/webhook/route.ts`**
   - Added Telegram notification for ALL payment status changes
   - Notifies on: `pending`, `approved`, `rejected`

3. **`lib/notifications.ts`** (NEW)
   - Centralized Telegram notification function
   - Includes logging for debugging

4. **`app/api/test-telegram/route.ts`** (NEW)
   - Test endpoint for verifying Telegram integration
   - Access: `POST /api/test-telegram`

---

## ğŸ’³ Mercado Pago Configuration

### Payment Methods

| Method | Status | Notes |
|--------|--------|-------|
| âœ… PIX | Enabled | Primary payment method |
| âœ… Credit Card | Enabled | Single card only |
| âŒ Boleto | Disabled | `ticket` type excluded |
| âŒ Caixa Card | Disabled | `caixa` method excluded |
| âŒ 2 Cards | Disabled | `melicard` excluded |
| âŒ Consumer Credits | Disabled | `consumer_credits` excluded |
| âŒ Lottery Payment | Disabled | `pec` excluded |

### Code Configuration

```typescript
payment_methods: {
    excluded_payment_types: [
        { id: "ticket" }  // Excludes boleto
    ],
    excluded_payment_methods: [
        { id: "pec" },           // Lottery payment
        { id: "caixa" },         // Caixa card
        { id: "melicard" },      // 2 cards / Mercado Credit
        { id: "consumer_credits" } // MP credit line
    ],
    installments: 12
}
```

### Price Configuration

- **Product:** Workshop Nanobanana Core
- **Price:** R$ 27,90
- **Statement Descriptor:** "WORKSHOP NB"

---

## ğŸ” Environment Variables

### Required in Vercel Production

| Variable | Description |
|----------|-------------|
| `MP_ACCESS_TOKEN` | Mercado Pago Access Token |
| `NEXT_PUBLIC_MP_PUBLIC_KEY` | Mercado Pago Public Key |
| `NEXT_PUBLIC_BASE_URL` | https://workshop.agentikai.app |
| `TELEGRAM_BOT_TOKEN` | Telegram Bot Token |
| `TELEGRAM_CHAT_ID` | Telegram Chat ID for notifications |
| `NOTION_TOKEN` | (Optional) Notion API token for CRM |

### Telegram Bot Details

- **Bot Name:** Workshop notificaÃ§Ã£o
- **Bot Username:** @Workshopathenaa_bot
- **Bot Token:** `8532708123:AAEsaj2eDDpAFZW50CtwiE3owwXI3cqcOIc`
- **Chat ID:** `562197237`

---

## ğŸ“ Project Structure (Key Files)

```
workshop-athena-checkout/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ mercadopago/
â”‚   â”‚   â”‚   â”œâ”€â”€ checkout/route.ts    # Payment preference creation
â”‚   â”‚   â”‚   â””â”€â”€ webhook/route.ts     # Payment status webhook
â”‚   â”‚   â””â”€â”€ test-telegram/route.ts   # Notification test endpoint
â”‚   â”œâ”€â”€ page.tsx                     # Main checkout page
â”‚   â””â”€â”€ success/page.tsx             # Success page after payment
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ notifications.ts             # Telegram notification utility
â”œâ”€â”€ components/
â”‚   â””â”€â”€ ...                          # UI components
â””â”€â”€ .env.local                       # Local environment variables
```

---

## ğŸš€ Deployment

### Commands

```bash
# Build locally
npm run build

# Deploy to Vercel
npx vercel --prod
```

### Vercel Project

- **Team:** agentikai
- **Project:** workshop-athena-checkout
- **Production URL:** https://workshop.agentikai.app

---

## ğŸ§ª Testing

### Test Telegram Notifications

```bash
# Via PowerShell
Invoke-RestMethod -Uri "https://workshop.agentikai.app/api/test-telegram" -Method Post

# Or locally
Invoke-RestMethod -Uri "http://localhost:3000/api/test-telegram" -Method Post
```

### Test Checkout Flow

1. Go to https://workshop.agentikai.app
2. Fill out the form (Name, Email, WhatsApp)
3. Click "IR PARA PAGAMENTO"
4. You should receive a Telegram notification
5. Complete payment (PIX or Card)
6. You should receive another notification with payment status

---

## ğŸ“ Notes

- The Telegram notifications are **fire-and-forget** in the checkout route to avoid blocking the payment flow
- The webhook receives ALL status changes from Mercado Pago (pending, approved, rejected, etc.)
- Notion CRM integration is optional and only saves `approved` payments
- The test endpoint should be removed or protected in production

---

## ğŸ”§ Troubleshooting

### Notifications not arriving?

1. Check Vercel environment variables are set correctly
2. Test with `/api/test-telegram` endpoint
3. Ensure bot has been started (send `/start` to @Workshopathenaa_bot)
4. Check Vercel function logs for errors

### Payment methods not showing correctly?

1. Verify `MP_ACCESS_TOKEN` is valid
2. Check the `excluded_payment_methods` configuration
3. Some methods may be restricted by Mercado Pago based on account type

---

*Documentation generated: 2026-02-01 23:47 BRT*
